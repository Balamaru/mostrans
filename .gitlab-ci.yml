stages:
  - build
  - deploy

variables:
  DOCKER_HOST: "tcp://docker:2375/"
  DOCKER_DRIVER: overlay2

services:
  - docker:dind

# -----------------------------
# BUILD BACKEND
# -----------------------------
build_backend:
  stage: build
  image: docker:latest
  script:
    - docker build -t backend-app:latest -f Dockerfile.backend .
  artifacts:
    paths:
      - backend/
  only:
    - main

# -----------------------------
# BUILD FRONTEND
# -----------------------------
build_frontend:
  stage: build
  image: docker:latest
  script:
    - docker build -t frontend-app:latest -f Dockerfile.frontend .
  artifacts:
    paths:
      - frontend/
  only:
    - main

# -----------------------------
# DEPLOY USING DOCKER COMPOSE
# -----------------------------
deploy:
  stage: deploy
  image: docker:latest
  before_script:
    - apk add --no-cache docker-compose
  script:
    - docker-compose down || true
    - docker-compose up -d --build
  only:
    - main
